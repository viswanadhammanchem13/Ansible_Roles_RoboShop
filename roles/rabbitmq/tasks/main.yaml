  - name: Copying rabbitmq repo
    ansible.builtin.copy:
      src: rabbitmq.repo
      dest: /etc/yum.repos.d/rabbitmq.repo

  - name: Installing rabbitmq
    ansible.builtin.dnf:
      name: "{{ item }}"
      state:  installed
    loop:
    - erlang
    - rabbitmq-server

  - name: Starting and enabling service
    ansible.builtin.service:
      name: rabbitmq-server
      state: started
      enabled: yes

  - name: check roboshop user is created or not.
    ansible.builtin.command: id roboshop
    register: User_Output
    ignore_errors: true

  - name: Setting username and password
    community.rabbitmq.rabbitmq_user:
      user: roboshop
      password: "{{ MY_Rabbitmq_PWD }}"
    register: User_Output
    debug:
      msg:"User is created with root password"
    when: User_Output.rc == 0


  - name: Printing the User Info
    ansible.builtin.debug:
      msg: "User is created with root password "
    when: User_Output.changed


  - name: Setting Permissions for user
    community.rabbitmq.rabbitmq_user:
      user: roboshop
      permissions:
        - vhost: /
          configure_priv: .*
          read_priv: .*
          write_priv: .*
      state: present